/**
 * filtrr.js - Javascript Image Processing Library
 * 
 * Copyright (C) 2011 Alex Michael
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do
 * so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 **/
/* The filtr object contains all the image processing functions,
  * and it is returned as a parameter to the callback passed in filtrr.
  */
var filtr=function(a){if(!a)throw"Canvas supplied to filtr was null or undefined.";var b=a,c=b.width,d=b.height,e=b.getContext("2d"),f=e.getImageData(0,0,c,d),g=function(a){return Math.min(255,Math.max(0,a))};this.duplicate=function(){return new filtr(b)},this.put=function(){e.putImageData(f,0,0)},this.canvas=function(){return b},this.getCurrentImageData=function(){return f},this.core={apply:function(a){var b=f.data,e=0,g=0;for(e=0;e<d;e++)for(g=0;g<c;g++){var i=e*c*4+g*4,j=a(b[i],b[i+1],b[i+2],b[i+3]);b[i]=j.r,b[i+1]=j.g,b[i+2]=j.b,b[i+3]=j.a}return this},convolve:function(a){if(!a)throw"Kernel was null in convolve function.";if(a.length===0)throw"Kernel length was 0 in convolve function.";var b=f;if(!e.createImageData)throw"createImageData is not supported.";var i=e.createImageData(b.width,b.height),j=i.data,k=f.data,l=parseInt(a.length/2),m=parseInt(a[0].length/2),n=0,o=0,p=0,q=0;for(n=0;n<d;n++)for(o=0;o<c;o++){var r=n*c*4+o*4,s=0,t=0,u=0;for(p=-l;p<=l;p++)for(q=-m;q<=m;q++)if(n+p>=0&&n+p<d&&o+q>=0&&o+q<c){var v=a[p+l][q+m];if(v===0)continue;var x=(n+p)*c*4+(o+q)*4;s+=k[x]*v,t+=k[x+1]*v,u+=k[x+2]*v}j[r]=g(s),j[r+1]=g(t),j[r+2]=g(u),j[r+3]=255}return i},edgeDetection:function(a){var b=f,i=f.data,j=0,k=0,l=0;if(a.toLowerCase()==="simple"){if(!e.createImageData)throw"createImageData is not supported.";var m=e.createImageData(b.width,b.height),n=m.data;for(j=0;j<d;j++)for(k=1;k<c;k++){l=j*c*4+k*4;var o=j*c*4+(k-1)*4;n[l]=g(Math.abs(i[l]-i[o])),n[l+1]=g(Math.abs(i[l+1]-i[o+1])),n[l+2]=g(Math.abs(i[l+2]-i[o+2])),n[l+3]=255}f=m}else if(a.toLowerCase()==="sobel"){var p=this.convolve([[-1,-2,-1],[0,0,0],[1,2,1]]),q=this.convolve([[-1,0,1],[-2,0,2],[-1,0,1]]),r=p.data,s=q.data;for(j=0;j<d;j++)for(k=0;k<c;k++){l=j*c*4+k*4;var t=r[l],u=s[l],v=r[l+1],x=s[l+1],y=r[l+2],z=s[l+2];i[l]=Math.sqrt(t*t+u*u),i[l+1]=Math.sqrt(v*v+x*x),i[l+2]=Math.sqrt(y*y+z*z)}f=b}else a.toLowerCase()!=="canny";return this},adjust:function(a,b,c){return this.apply(function(d,e,f,h){return{r:g(d*(1+a)),g:g(e*(1+b)),b:g(f*(1+c)),a:h}}),a=b=c=null,this},brightness:function(a){return this.apply(function(b,c,d,e){return{r:g(b+a),g:g(c+a),b:g(d+a),a:e}}),a=null,this},fill:function(a,b,c){return this.apply(function(d,e,f,h){return{r:g(a),g:g(b),b:g(c),a:h}}),rf=b=c=null,this},opacity:function(a){return this.apply(function(b,c,d,e){return{r:b,g:c,b:d,a:g(a*e)}}),a=null,this},saturation:function(a){return this.apply(function(b,c,d,e){var f=(b+c+d)/3;return{r:g(f+a*(b-f)),g:g(f+a*(c-f)),b:g(f+a*(d-f)),a:e}}),a=null,this},threshold:function(a){return this.apply(function(b,c,d,e){var f=255;if(b<a||c<a||d<a)f=0;return{r:f,g:f,b:f,a:e}}),a=null,this},posterize:function(a){var b=Math.floor(255/a);return this.apply(function(a,c,d,e){return{r:g(Math.floor(a/b)*b),g:g(Math.floor(c/b)*b),b:g(Math.floor(d/b)*b),a:e}}),b=null,a=null,this},gamma:function(a){return this.apply(function(b,c,d,e){return{r:g(Math.pow(b,a)),g:g(Math.pow(c,a)),b:g(Math.pow(d,a)),a:e}}),a=null,this},negative:function(){return this.apply(function(a,b,c,d){return{r:g(255-a),g:g(255-b),b:g(255-c),a:d}}),this},grayScale:function(){return this.apply(function(a,b,c,d){var e=(a+b+c)/3;return{r:g(e),g:g(e),b:g(e),a:d}}),this},bump:function(){return f=this.convolve([[-1,-1,0],[-1,1,1],[0,1,1]]),this},tint:function(a,b){return this.apply(function(c,d,e,f){return{r:g((c-a[0])*(255/(b[0]-a[0]))),g:g((d-a[1])*(255/(b[1]-a[1]))),b:g((e-a[2])*(255/(b[2]-a[2]))),a:f}}),a=b=null,this},mask:function(a,b,c){return this.apply(function(d,e,f,h){return{r:g(d&a),g:g(e&b),b:g(f&c),a:h}}),a=b=c=null,this},sepia:function(){return this.apply(function(a,b,c,d){return{r:g(a*.393+b*.769+c*.189),g:g(a*.349+b*.686+c*.168),b:g(a*.272+b*.534+c*.131),a:d}}),this},bias:function(a){function b(a,b){return a/((1/b-1.9)*(.9-a)+1)}return this.apply(function(c,d,e,f){return{r:g(c*b(c/255,a)),g:g(d*b(d/255,a)),b:g(e*b(e/255,a)),a:f}}),a=null,this},contrast:function(a){function b(a,b){return(a-.5)*b+.5}return this.apply(function(c,d,e,f){return{r:g(255*b(c/255,a)),g:g(255*b(d/255,a)),b:g(255*b(e/255,a)),a:f}}),a=null,this},blur:function(){return f=this.convolve([[1,2,1],[2,2,2],[1,2,1]]),this},sharpen:function(){return f=this.convolve([[0,-0.2,0],[-0.2,1.8,-0.2],[0,-0.2,0]]),this},gaussianBlur:function(){return f=this.convolve([[1/273,4/273,7/273,4/273,1/273],[4/273,16/273,26/273,16/273,4/273],[7/273,26/273,41/273,26/273,7/273],[4/273,16/273,26/273,16/273,4/273],[1/273,4/273,7/273,4/273,1/273]]),this}},this.blend={apply:function(a,b){var e=a.getCurrentImageData(),g=e.data,i=f.data,j=0,k=0;for(j=0;j<d;j++)for(k=0;k<c;k++){var l=j*c*4+k*4,m=b({r:g[l],g:g[l+1],b:g[l+2],a:g[l+3]},{r:i[l],g:i[l+1],b:i[l+2],a:i[l+3]});i[l]=m.r,i[l+1]=m.g,i[l+2]=m.b,i[l+3]=m.a}},multiply:function(a){return this.apply(a,function(a,b){return{r:g(a.r*b.r/255),g:g(a.g*b.g/255),b:g(a.b*b.b/255),a:b.a}}),this},screen:function(a){return this.apply(a,function(a,b){return{r:g(255-(255-a.r)*(255-b.r)/255),g:g(255-(255-a.g)*(255-b.g)/255),b:g(255-(255-a.b)*(255-b.b)/255),a:b.a}}),this},overlay:function(a){function b(a,b){return a>128?255-2*(255-b)*(255-a)/255:a*b*2/255}return this.apply(a,function(a,c){return{r:g(b(c.r,a.r)),g:g(b(c.g,a.g)),b:g(b(c.b,a.b)),a:c.a}}),this},difference:function(a){return this.apply(a,function(a,b){return{r:g(Math.abs(a.r-b.r)),g:g(Math.abs(a.g-b.g)),b:g(Math.abs(a.b-b.b)),a:b.a}}),this},addition:function(a){return this.apply(a,function(a,b){return{r:g(a.r+b.r),g:g(a.g+b.g),b:g(a.b+b.b),a:b.a}}),this},exclusion:function(a){return this.apply(a,function(a,b){return{r:g(128-2*(b.r-128)*(a.r-128)/255),g:g(128-2*(b.g-128)*(a.g-128)/255),b:g(128-2*(b.b-128)*(a.b-128)/255),a:b.a}}),this},softLight:function(a){function b(a,b){return a>128?255-(255-a)*(255-(b-128))/255:a*(b+128)/255}return this.apply(a,function(a,c){return{r:g(b(c.r,a.r)),g:g(b(c.g,a.g)),b:g(b(c.b,a.b)),a:c.a}}),this}}},filtrr=new function(){var a=function(a){return typeof a=="string"||!isNaN(a)||a.substring},b=function(a){var b=0,c=0;if(a.offsetParent)for(;;){c+=a.offsetTop,b+=a.offsetLeft;if(!a.offsetParent)break;a=a.offsetParent}else a.x&&(b+=a.x),a.y&&(c+=a.y);return{top:c,left:b}};this.img=function(c,d){var e=a(c)?document.getElementById(c):c;if(!e)throw"Could not find image element with id: "+id;var f=new Image;f.onload=function(){var a=document.createElement("canvas");a.width=f.width,a.height=f.height,a.getContext("2d").drawImage(f,0,0);var c=b(e),g=b(e.offsetParent),h=$(e).parent();h.size()>0&&(h[0].appendChild(a),e.style.display="none"),f=null,e=null,d(new filtr(a))},f.src=e.getAttribute("src")},this.canvas=function(b,c){var d=a(b)?document.getElementById(b):b;if(!d)throw"Could not find element with id: "+id;c(new filtr(d))}};