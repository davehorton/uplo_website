/*
 * jQuery File Upload User Interface Plugin 6.0.2
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
/*jslint nomen: true, unparam: true, regexp: true */
/*global window, document, URL, webkitURL, FileReader, jQuery */
(function(e){"use strict";function t(){e("#upload-counter").remove();var t=document.createElement("div");t.id="upload-counter";var n=e(".template-upload").size(),r=n+" file(s) is ready to upload";t.innerHTML=r,e(".gallery-header").append(t)}e.widget("blueimpUI.fileupload",e.blueimp.fileupload,{options:{autoUpload:!1,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:1,acceptFileTypes:/.+$/i,previewFileTypes:/^image\/(gif|jpeg|png)$/,previewMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,dataType:"json",displayNumber:5,add:function(n,r){console.log(e(this));var i=e(this).data("fileupload"),s=r.files;i._adjustMaxNumberOfFiles(-s.length),r.isAdjusted=!0,r.files.valid=r.isValidated=i._validate(s),r.context=i._renderUpload(s).prependTo(e(this).find(".files.upload")).data("data",r),t(),i._reflow=i._transition&&r.context[0].offsetWidth,r.context.addClass("in"),(i.options.autoUpload||r.autoUpload)&&r.isValidated&&r.submit()},send:function(t,n){if(!n.isValidated){var r=e(this).data("fileupload");n.isAdjusted||r._adjustMaxNumberOfFiles(-n.files.length);if(!r._validate(n.files))return!1}n.context&&n.dataType&&n.dataType.substr(0,6)==="iframe"&&n.context.find(".progressbar div").css("width",parseInt(100,10)+"%")},done:function(n,r){var i=e(this).data("fileupload"),s,o;r.context?r.context.each(function(n){var u=e.isArray(r.result)&&r.result[n]||{error:"emptyResult"};u.error&&i._adjustMaxNumberOfFiles(1),i._transitionCallback(e(this).removeClass("in"),function(n){s=i._renderDownload([u]),o=n.find(".preview img, .preview canvas"),o.length&&s.find(".preview img").prop("width",o.prop("width")).prop("height",o.prop("height")),s.replaceAll(n).prependTo(e(".files.download")),t(),i._reflow=i._transition&&s[0].offsetWidth,s.addClass("in")})}):(s=i._renderDownload(r.result).prependTo(e(".files.download")),i._reflow=i._transition&&s[0].offsetWidth,s.addClass("in"),e(".files.download").children().size()>this.options.displayNumber&&e(".files.download").children().last().remove())},fail:function(t,n){var r=e(this).data("fileupload"),i;r._adjustMaxNumberOfFiles(n.files.length),n.context?n.context.each(function(t){if(n.errorThrown!=="abort"){var s=n.files[t];s.error=s.error||n.errorThrown||!0,r._transitionCallback(e(this).removeClass("in"),function(e){i=r._renderDownload([s]).replaceAll(e),r._reflow=r._transition&&i[0].offsetWidth,i.addClass("in")})}else r._transitionCallback(e(this).removeClass("in"),function(e){e.remove()})}):n.errorThrown!=="abort"&&(r._adjustMaxNumberOfFiles(-n.files.length),n.context=r._renderUpload(n.files).appendTo(r._files).data("data",n),r._reflow=r._transition&&n.context[0].offsetWidth,n.context.addClass("in"))},progress:function(e,t){t.context&&t.context.find(".progressbar div").css("width",parseInt(t.loaded/t.total*100,10)+"%")},progressall:function(t,n){e(this).find(".fileupload-progressbar div").css("width",parseInt(n.loaded/n.total*100,10)+"%")},start:function(){e(this).find(".fileupload-progressbar div").css("width","0%")},stop:function(){e(this).find(".fileupload-progressbar div").css("width","0%")},destroy:function(t,n){var r=e(this).data("fileupload");n.url&&(n.success=function(t){t.success==1?e.get(e("#fileupload").prop("action"),function(t){var n=e("#fileupload").data("fileupload"),r=e("#fileupload .files.download"),i;r.empty(),n._adjustMaxNumberOfFiles(-t.length),i=n._renderDownload(t).appendTo(r),n._reflow=n._transition&&i.length&&i[0].offsetWidth,i.addClass("in")}):helper.show_notification("Something went wrong! Cannot delete this picture")},e.ajax(n))}},_enableDragToDesktop:function(){var t=e(this),n=t.prop("href"),r=decodeURIComponent(n.split("/").pop()).replace(/:/g,"-"),i="application/octet-stream";t.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[i,r,n].join(":"))}catch(t){}})},_adjustMaxNumberOfFiles:function(e){typeof this.options.maxNumberOfFiles=="number"&&(this.options.maxNumberOfFiles+=e,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(e){return typeof e!="number"?"":e>=1e9?(e/1e9).toFixed(2)+" GB":e>=1e6?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"},_hasError:function(e){return e.error?e.error:this.options.maxNumberOfFiles<0?"maxNumberOfFiles":!this.options.acceptFileTypes.test(e.type)&&!this.options.acceptFileTypes.test(e.name)?"acceptFileTypes":this.options.maxFileSize&&e.size>this.options.maxFileSize?"maxFileSize":typeof e.size=="number"&&e.size<this.options.minFileSize?"minFileSize":null},_validate:function(t){var n=this,r=!!t.length;return e.each(t,function(e,t){t.error=n._hasError(t),t.error&&(r=!1)}),r},_renderTemplate:function(t,n){return e(this.options.templateContainer).html(t({files:n,formatFileSize:this._formatFileSize,options:this.options})).children()},_renderUpload:function(t){var n=this,r=this.options,i=this._renderTemplate(r.uploadTemplate,t);return i.find(".preview span").each(function(i,s){var o=t[i];r.previewFileTypes.test(o.type)&&(!r.previewMaxFileSize||o.size<r.previewMaxFileSize)&&window.loadImage(t[i],function(t){e(s).append(t),n._reflow=n._transition&&s.offsetWidth,e(s).addClass("in")},{maxWidth:r.previewMaxWidth,maxHeight:r.previewMaxHeight,canvas:r.previewAsCanvas})}),i},_renderDownload:function(e){var t=this._renderTemplate(this.options.downloadTemplate,e);return t.find("a").each(this._enableDragToDesktop),t},_startHandler:function(t){t.preventDefault();var n=e(this),r=n.closest(".template-upload"),i=r.data("data");i&&i.submit&&!i.jqXHR&&i.submit()&&n.prop("disabled",!0)},_cancelHandler:function(n){n.preventDefault();var r=e(this).closest(".template-upload"),i=r.data("data")||{};i.jqXHR?i.jqXHR.abort():(i.errorThrown="abort",n.data.fileupload._trigger("fail",n,i)),window.setTimeout(function(){t()},200)},_editHandler:function(t){t.preventDefault();var n=e(this);window.location=n.attr("data-url")},_deleteHandler:function(t){t.preventDefault();var n=e(this);t.data.fileupload._trigger("destroy",t,{context:n.closest(".template-download"),url:n.attr("data-url"),type:n.attr("data-type"),dataType:t.data.fileupload.options.dataType})},_transitionCallback:function(e,t){var n=this;this._transition&&e.hasClass("fade")?e.bind(this._transitionEnd,function(r){r.target===e[0]&&(e.unbind(n._transitionEnd),t.call(n,e))}):t.call(this,e)},_initTransitionSupport:function(){var e=this,t=(document.body||document.documentElement).style,n="."+e.options.namespace;e._transition=t.transition!==undefined||t.WebkitTransition!==undefined||t.MozTransition!==undefined||t.MsTransition!==undefined||t.OTransition!==undefined,e._transition&&(e._transitionEnd=["TransitionEnd","webkitTransitionEnd","transitionend","oTransitionEnd"].join(n+" ")+n)},_initButtonBarEventHandlers:function(){var t=this.element.find(".fileupload-buttonbar"),n=this._files,r=this.options.namespace;t.find(".start").bind("click."+r,function(e){e.preventDefault(),n.find(".start button").click()}),t.find(".cancel").bind("click."+r,function(e){e.preventDefault(),n.find(".cancel button").click()}),t.find(".delete").bind("click."+r,function(t){t.preventDefault();var r=e("#fileupload").data("fileupload"),i=[],s,o;return s=n.find(".delete input:checked"),s.each(function(e,t){i.push(t.getAttribute("data-id"))}),o=e(s[0]).siblings("button").attr("data-url"),o=o.substr(0,o.lastIndexOf("/")),o=o+"/"+i,e.ajax({url:o,success:function(t){t.success==1&&s.each(function(t,n){var i=e(n).closest(".template-download");r._adjustMaxNumberOfFiles(1),r._transitionCallback(i.removeClass("in"),function(e){e.remove()})})}}),!1}),t.find(".toggle").bind("change."+r,function(t){n.find(".delete input").prop("checked",e(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace),this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){var t=this;e.blueimp.fileupload.prototype._initEventHandlers.call(this);var n={fileupload:this};this._files.delegate(".start button","click."+this.options.namespace,n,this._startHandler).delegate(".cancel button","click."+this.options.namespace,n,this._cancelHandler).delegate(".edit button","click."+this.options.namespace,n,this._editHandler).delegate(".delete button","click."+this.options.namespace,n,this._deleteHandler),this._initButtonBarEventHandlers(),this._initTransitionSupport()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._files.undelegate(".start button","click."+this.options.namespace).undelegate(".cancel button","click."+this.options.namespace).undelegate(".delete button","click."+this.options.namespace),e.blueimp.fileupload.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){this.options.templateContainer=document.createElement(this._files.prop("nodeName")),this.options.uploadTemplate=window.tmpl("template-upload"),this.options.downloadTemplate=window.tmpl("template-download")},_initFiles:function(){this._files=this.element.find(".files")},_create:function(){this._initFiles(),e.blueimp.fileupload.prototype._create.call(this),this._initTemplates()},destroy:function(){e.blueimp.fileupload.prototype.destroy.call(this)},enable:function(){e.blueimp.fileupload.prototype.enable.call(this),this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton(),e.blueimp.fileupload.prototype.disable.call(this)}})})(jQuery);