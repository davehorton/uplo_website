(function(e){var t=e(window);e.fn.asynchImageLoader=e.fn.jail=function(n){return n=e.extend({timeout:10,effect:!1,speed:400,selector:null,offset:0,event:"load+scroll",callback:jQuery.noop,callbackAfterEachImage:jQuery.noop,placeholder:!1,ignoreHiddenImages:!1},n),e.jail.initialStack=this,this.data("triggerEl",n.selector?e(n.selector):t),n.placeholder!==!1&&this.each(function(){e(this).attr("src",n.placeholder)}),/^load/.test(n.event)?e.asynchImageLoader.later.call(this,n):e.asynchImageLoader.onEvent.call(this,n,this),this},e.asynchImageLoader=e.jail={_purgeStack:function(e){for(var t=0;;){if(t===e.length)break;e[t].getAttribute("data-href")?t++:e.splice(t,1)}},_loadOnEvent:function(t){var n=e(this),r=t.data.options,t=t.data.images;e.asynchImageLoader._loadImageIfVisible(r,n),n.unbind(r.event,e.asynchImageLoader._loadOnEvent),e.asynchImageLoader._purgeStack(t),r.callback&&(e.asynchImageLoader._purgeStack(e.jail.initialStack),e.asynchImageLoader._launchCallback(e.jail.initialStack,r))},_bufferedEventListener:function(t){var n=t.data.images,r=t.data.options,i=n.data("triggerEl");clearTimeout(n.data("poller")),n.data("poller",setTimeout(function(){n.each(function(){e.asynchImageLoader._loadImageIfVisible(r,this,i)}),e.asynchImageLoader._purgeStack(n),r.callback&&(e.asynchImageLoader._purgeStack(e.jail.initialStack),e.asynchImageLoader._launchCallback(e.jail.initialStack,r))},r.timeout))},onEvent:function(n,r){r=r||this;if(n.event==="scroll"||n.selector){var i=r.data("triggerEl");r.length>0?(i.bind(n.event,{images:r,options:n},e.asynchImageLoader._bufferedEventListener),(n.event==="scroll"||!n.selector)&&t.resize({images:r,options:n},e.asynchImageLoader._bufferedEventListener)):i&&i.unbind(n.event,e.asynchImageLoader._bufferedEventListener)}else r.bind(n.event,{options:n,images:r},e.asynchImageLoader._loadOnEvent)},later:function(t){var n=this;t.event==="load"&&n.each(function(){e.asynchImageLoader._loadImageIfVisible(t,this,n.data("triggerEl"))}),e.asynchImageLoader._purgeStack(n),e.asynchImageLoader._launchCallback(n,t),setTimeout(function(){t.event==="load"?n.each(function(){e.asynchImageLoader._loadImage(t,e(this))}):n.each(function(){e.asynchImageLoader._loadImageIfVisible(t,this,n.data("triggerEl"))}),e.asynchImageLoader._purgeStack(n),e.asynchImageLoader._launchCallback(n,t),t.event==="load+scroll"&&(t.event="scroll",e.asynchImageLoader.onEvent(t,n))},t.timeout)},_launchCallback:function(t,n){t.length===0&&!e.jail.isCallback&&(n.callback.call(this,n),e.jail.isCallback=!0)},_loadImageIfVisible:function(n,r,i){var r=e(r),i=/scroll/i.test(n.event)&&i.length>0?i:t,s=!0;n.ignoreHiddenImages&&(s=e.jail._isVisibleInOverflownContainer(r,n)&&r.is(":visible")),s&&e.asynchImageLoader._isInTheScreen(i,r,n.offset)&&e.asynchImageLoader._loadImage(n,r)},_isInTheScreen:function(e,t,n){var r=e[0]===window,i=r?{top:0,left:0}:e.offset(),s=i.top+(r?e.scrollTop():0),r=i.left+(r?e.scrollLeft():0),i=r+e.width(),e=s+e.height(),o=t.offset(),u=t.width(),t=t.height();return s-n<=o.top+t&&e+n>=o.top&&r-n<=o.left+u&&i+n>=o.left},_loadImage:function(e,t){t.hide(),t.attr("src",t.attr("data-href")),t.removeAttr("data-href"),e.effect?e.speed?t[e.effect](e.speed):t[e.effect]():t.show(),e.callbackAfterEachImage.call(this,t,e)},_isVisibleInOverflownContainer:function(t,n){for(var r=t.parent(),i=!0;r.get(0).tagName!=="BODY";){if(r.css("overflow")==="hidden"&&!e.jail._isInTheScreen(r,t,n.offset)){i=!1;break}if(r.css("visibility")==="hidden"||t.css("visibility")==="hidden"){i=!1;break}r=r.parent()}return i}}})(jQuery);