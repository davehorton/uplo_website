(function(a){var b=a(window);a.fn.asynchImageLoader=a.fn.jail=function(d){return d=a.extend({timeout:10,effect:!1,speed:400,selector:null,offset:0,event:"load+scroll",callback:jQuery.noop,callbackAfterEachImage:jQuery.noop,placeholder:!1,ignoreHiddenImages:!1},d),a.jail.initialStack=this,this.data("triggerEl",d.selector?a(d.selector):b),d.placeholder!==!1&&this.each(function(){a(this).attr("src",d.placeholder)}),/^load/.test(d.event)?a.asynchImageLoader.later.call(this,d):a.asynchImageLoader.onEvent.call(this,d,this),this},a.asynchImageLoader=a.jail={_purgeStack:function(a){for(var b=0;;){if(b===a.length)break;a[b].getAttribute("data-href")?b++:a.splice(b,1)}},_loadOnEvent:function(b){var d=a(this),e=b.data.options,b=b.data.images;a.asynchImageLoader._loadImageIfVisible(e,d),d.unbind(e.event,a.asynchImageLoader._loadOnEvent),a.asynchImageLoader._purgeStack(b),e.callback&&(a.asynchImageLoader._purgeStack(a.jail.initialStack),a.asynchImageLoader._launchCallback(a.jail.initialStack,e))},_bufferedEventListener:function(b){var d=b.data.images,e=b.data.options,f=d.data("triggerEl");clearTimeout(d.data("poller")),d.data("poller",setTimeout(function(){d.each(function(){a.asynchImageLoader._loadImageIfVisible(e,this,f)}),a.asynchImageLoader._purgeStack(d),e.callback&&(a.asynchImageLoader._purgeStack(a.jail.initialStack),a.asynchImageLoader._launchCallback(a.jail.initialStack,e))},e.timeout))},onEvent:function(d,e){e=e||this;if(d.event==="scroll"||d.selector){var g=e.data("triggerEl");e.length>0?(g.bind(d.event,{images:e,options:d},a.asynchImageLoader._bufferedEventListener),(d.event==="scroll"||!d.selector)&&b.resize({images:e,options:d},a.asynchImageLoader._bufferedEventListener)):g&&g.unbind(d.event,a.asynchImageLoader._bufferedEventListener)}else e.bind(d.event,{options:d,images:e},a.asynchImageLoader._loadOnEvent)},later:function(b){var d=this;b.event==="load"&&d.each(function(){a.asynchImageLoader._loadImageIfVisible(b,this,d.data("triggerEl"))}),a.asynchImageLoader._purgeStack(d),a.asynchImageLoader._launchCallback(d,b),setTimeout(function(){b.event==="load"?d.each(function(){a.asynchImageLoader._loadImage(b,a(this))}):d.each(function(){a.asynchImageLoader._loadImageIfVisible(b,this,d.data("triggerEl"))}),a.asynchImageLoader._purgeStack(d),a.asynchImageLoader._launchCallback(d,b),b.event==="load+scroll"&&(b.event="scroll",a.asynchImageLoader.onEvent(b,d))},b.timeout)},_launchCallback:function(b,d){b.length===0&&!a.jail.isCallback&&(d.callback.call(this,d),a.jail.isCallback=!0)},_loadImageIfVisible:function(d,e,g){var e=a(e),g=/scroll/i.test(d.event)&&g.length>0?g:b,h=!0;d.ignoreHiddenImages&&(h=a.jail._isVisibleInOverflownContainer(e,d)&&e.is(":visible")),h&&a.asynchImageLoader._isInTheScreen(g,e,d.offset)&&a.asynchImageLoader._loadImage(d,e)},_isInTheScreen:function(a,b,c){var d=a[0]===window,e=d?{top:0,left:0}:a.offset(),f=e.top+(d?a.scrollTop():0),d=e.left+(d?a.scrollLeft():0),e=d+a.width(),a=f+a.height(),g=b.offset(),h=b.width(),b=b.height();return f-c<=g.top+b&&a+c>=g.top&&d-c<=g.left+h&&e+c>=g.left},_loadImage:function(a,b){b.hide(),b.attr("src",b.attr("data-href")),b.removeAttr("data-href"),a.effect?a.speed?b[a.effect](a.speed):b[a.effect]():b.show(),a.callbackAfterEachImage.call(this,b,a)},_isVisibleInOverflownContainer:function(b,d){for(var e=b.parent(),f=!0;e.get(0).tagName!=="BODY";){if(e.css("overflow")==="hidden"&&!a.jail._isInTheScreen(e,b,d.offset)){f=!1;break}if(e.css("visibility")==="hidden"||b.css("visibility")==="hidden"){f=!1;break}e=e.parent()}return f}}})(jQuery)