/*
 * Bootstrap Image Gallery 1.0.2
 * https://github.com/blueimp/Bootstrap-Image-Gallery
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
/*jslint nomen: true */
/*global window, document, jQuery */
(function(e){"use strict";e.widget("blueimp.imagegallery",{options:{namespace:undefined,selector:"a[rel=gallery]",modalSelector:"#gallery-modal",loaderSelector:"#gallery-loader",backdrop:!0,keyboard:!0,offsetWidth:100,offsetHeight:200,canvas:!1,slideshow:0},_load:function(t){var n=t.data.gallery,r=n.options,i=e(window).width(),s=e(window).height(),o=n._modal.hasClass("fullscreen"),u;t.preventDefault(),n._abortHandler(),window.clearTimeout(n._slideShow),n.defer=e.Deferred(),n._isModalLink=e(this).parent().hasClass("modal-footer"),n._isModalLink?(e(this).hasClass("next")?n._currentLink=e(n._currentLink).data("next"):n._currentLink=e(n._currentLink).data("prev"),n._modal.removeClass("in")):(n._initLinks(),n._currentLink=this,n._initAbortHandlers()),n._isModalLink&&n._transition&&n._modal.hasClass("fade")?n._modal.bind(n._transitionEnd+"."+r.namespace,function(e){e.target===n._modal[0]&&(n._modal.unbind(n._transitionEnd+"."+r.namespace),n._initModal(),n.defer.resolve())}):(n._modal.hide(),n._initModal(),n.defer.resolve()),o?u={minWidth:i,minHeight:s,maxWidth:i,maxHeight:s,canvas:r.canvas}:u={maxWidth:i-r.offsetWidth,maxHeight:s-r.offsetHeight,canvas:r.canvas},n._loadingImageTimeout=window.setTimeout(function(){n._loader.addClass("in")},100),n._loadingImage=window.loadImage(n._currentLink.href,function(e){n._loadHandler(e)},u),n._preload()},_loadHandler:function(e){var t=this;this._abortHandler(),this._isModalLink?this.defer.done(function(){t._modal.show(),t._modal.addClass("in"),t._initModalBody(e)}):(this._initModalBody(e),this._modal.modal("show")),this.options.slideshow&&(this._slideShow=window.setTimeout(function(){t._next()},this.options.slideshow))},_initLinks:function(){var t=e(this.element).find(this.options.selector);t.each(function(n,r){var i=t[n-1],s=t[n+1];if(!i||i.href===r.href){i=t[n-2];if(!i||i.href===r.href)i=t[t.length-1]}if(!s||s.href===r.href){s=t[n+2];if(!s||s.href===r.href)s=t[0]}e(r).data("prev",i),e(r).data("next",s)})},_initModal:function(){var t=e(this._currentLink).data("prev"),n=e(this._currentLink).data("next");this._modalTitle.text(this._currentLink.title),this._modalDownload.prop("href",this._currentLink.href),this._modalPrev.prop("href",t.href).prop("title",t.title),this._modalNext.prop("href",n.href).prop("title",n.title)},_initModalBody:function(e){this._modalBody.empty().append(e),this._modal.css("margin-top",-(this._modal.outerHeight()/2)).css("margin-left",-(this._modal.outerWidth()/2))},_preload:function(){e("<img>").prop("src",e(this._currentLink).data("next").href),e("<img>").prop("src",e(this._currentLink).data("prev").href)},_abortHandler:function(){window.clearTimeout(this._loadingImageTimeout),this._destroyAbortHandlers(),this._loadingImage&&(this._loadingImage.onload=this._loadingImage.onerror=null),this._loader.removeClass("in")},_escapeHandler:function(e){var t=e.data.gallery;e.keyCode===27&&t._abortHandler()},_documentClickHandler:function(t){var n=t.data.gallery;e(t.target).closest(n._currentLink).length||n._abortHandler()},_initAbortHandlers:function(){var t={gallery:this};e(document).bind("keydown."+this.options.namespace,t,this._escapeHandler).bind("click."+this.options.namespace,t,this._documentClickHandler)},_destroyAbortHandlers:function(){e(document).unbind("keydown."+this.options.namespace,this._escapeHandler).unbind("click."+this.options.namespace,this._documentClickHandler)},_prev:function(){this._modalPrev.click()},_next:function(){this._modalNext.click()},_keyHandler:function(e){var t=e.data.gallery;switch(e.which){case 37:case 38:return t._prev(),!1;case 39:case 40:return t._next(),!1}},_wheelHandler:function(e){var t=e.data.gallery;e=e.originalEvent,t._wheelCounter=t._wheelCounter||0,t._wheelCounter+=e.wheelDelta||e.detail||0;if(e.wheelDelta&&t._wheelCounter>=120||!e.wheelDelta&&t._wheelCounter<0)t._prev(),t._wheelCounter=0;else if(e.wheelDelta&&t._wheelCounter<=-120||!e.wheelDelta&&t._wheelCounter>0)t._next(),t._wheelCounter=0;return!1},_showHandler:function(t){var n=t.data.gallery,r=n.options,i={gallery:n};e(document).bind("keydown."+r.namespace,i,n._keyHandler).bind("mousewheel."+r.namespace+", DOMMouseScroll."+r.namespace,i,n._wheelHandler)},_hideHandler:function(t){var n=t.data.gallery,r=n.options;e(document).unbind("keydown."+r.namespace,n._keyHandler).unbind("mousewheel."+r.namespace+", DOMMouseScroll."+r.namespace,n._wheelHandler),n._abortHandler(),window.clearTimeout(n._slideShow)},_initEventHandlers:function(){var t=this,n={gallery:this};e(this.element).delegate(this.options.selector,"click."+this.options.namespace,n,this._load),this._modalPrev.bind("click."+this.options.namespace,n,this._load),this._modalNext.bind("click."+this.options.namespace,n,this._load),this._modalBody.bind("click."+this.options.namespace,n,function(e){e.altKey?t._prev():t._next()}),this._modal.bind("show."+this.options.namespace,n,this._showHandler).bind("hide."+this.options.namespace,n,this._hideHandler)},_destroyEventHandlers:function(){this._modalPrev.unbind("click."+this.options.namespace),this._modalNext.unbind("click."+this.options.namespace),this._modalBody.unbind("click."+this.options.namespace),this._modal.unbind("show."+this.options.namespace).unbind("hide."+this.options.namespace),e(this.element).undelegate(this.options.selector,"click."+this.options.namespace)},_initTransitionSupport:function(){var e=this,t=(document.body||document.documentElement).style,n="."+e.options.namespace;e._transition=t.transition!==undefined||t.WebkitTransition!==undefined||t.MozTransition!==undefined||t.MsTransition!==undefined||t.OTransition!==undefined,e._transition&&(e._transitionEnd=["TransitionEnd","webkitTransitionEnd","transitionend","oTransitionEnd"].join(n+" ")+n)},_create:function(){this.options.namespace=this.options.namespace||this.widgetName,this._modal=e(this.options.modalSelector).modal({backdrop:this.options.backdrop,keyboard:this.options.keyboard}),this._loader=e(this.options.loaderSelector),this._modalTitle=this._modal.find(".modal-header .title"),this._modalBody=this._modal.find(".modal-body"),this._modalDownload=this._modal.find(".modal-footer .download"),this._modalPrev=this._modal.find(".modal-footer .prev"),this._modalNext=this._modal.find(".modal-footer .next"),this._initTransitionSupport(),this._initEventHandlers()},destroy:function(){window.clearTimeout(this._slideShow),this._destroyEventHandlers(),e.Widget.prototype.destroy.call(this)}})})(jQuery);