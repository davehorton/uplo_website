(function(a){a.widget("blueimp.imagegallery",{options:{namespace:void 0,selector:"a[rel=gallery]",modalSelector:"#gallery-modal",loaderSelector:"#gallery-loader",backdrop:!0,keyboard:!0,offsetWidth:100,offsetHeight:200,canvas:!1,slideshow:0},_load:function(b){var d=b.data.gallery,e=d.options,f=a(window).width(),g=a(window).height(),h=d._modal.hasClass("fullscreen");b.preventDefault(),d._abortHandler(),window.clearTimeout(d._slideShow),d.defer=a.Deferred(),d._isModalLink=a(this).parent().hasClass("modal-footer"),d._isModalLink?(d._currentLink=a(this).hasClass("next")?a(d._currentLink).data("next"):a(d._currentLink).data("prev"),d._modal.removeClass("in")):(d._initLinks(),d._currentLink=this,d._initAbortHandlers()),d._isModalLink&&d._transition&&d._modal.hasClass("fade")?d._modal.bind(d._transitionEnd+"."+e.namespace,function(a){a.target===d._modal[0]&&(d._modal.unbind(d._transitionEnd+"."+e.namespace),d._initModal(),d.defer.resolve())}):(d._modal.hide(),d._initModal(),d.defer.resolve()),b=h?{minWidth:f,minHeight:g,maxWidth:f,maxHeight:g,canvas:e.canvas}:{maxWidth:f-e.offsetWidth,maxHeight:g-e.offsetHeight,canvas:e.canvas},d._loadingImageTimeout=window.setTimeout(function(){d._loader.addClass("in")},100),d._loadingImage=window.loadImage(d._currentLink.href,function(a){d._loadHandler(a)},b),d._preload()},_loadHandler:function(a){var b=this;this._abortHandler(),this._isModalLink?this.defer.done(function(){b._modal.show(),b._modal.addClass("in"),b._initModalBody(a)}):(this._initModalBody(a),this._modal.modal("show")),this.options.slideshow&&(this._slideShow=window.setTimeout(function(){b._next()},this.options.slideshow))},_initLinks:function(){var b=a(this.element).find(this.options.selector);b.each(function(d,e){var f=b[d-1],g=b[d+1];if(!f||f.href===e.href)if(f=b[d-2],!f||f.href===e.href)f=b[b.length-1];if(!g||g.href===e.href)if(g=b[d+2],!g||g.href===e.href)g=b[0];a(e).data("prev",f),a(e).data("next",g)})},_initModal:function(){var b=a(this._currentLink).data("prev"),d=a(this._currentLink).data("next");this._modalTitle.text(this._currentLink.title),this._modalDownload.prop("href",this._currentLink.href),this._modalPrev.prop("href",b.href).prop("title",b.title),this._modalNext.prop("href",d.href).prop("title",d.title)},_initModalBody:function(a){this._modalBody.empty().append(a),this._modal.css("margin-top",-(this._modal.outerHeight()/2)).css("margin-left",-(this._modal.outerWidth()/2))},_preload:function(){a("<img>").prop("src",a(this._currentLink).data("next").href),a("<img>").prop("src",a(this._currentLink).data("prev").href)},_abortHandler:function(){window.clearTimeout(this._loadingImageTimeout),this._destroyAbortHandlers(),this._loadingImage&&(this._loadingImage.onload=this._loadingImage.onerror=null),this._loader.removeClass("in")},_escapeHandler:function(a){var b=a.data.gallery;27===a.keyCode&&b._abortHandler()},_documentClickHandler:function(b){var d=b.data.gallery;a(b.target).closest(d._currentLink).length||d._abortHandler()},_initAbortHandlers:function(){var b={gallery:this};a(document).bind("keydown."+this.options.namespace,b,this._escapeHandler).bind("click."+this.options.namespace,b,this._documentClickHandler)},_destroyAbortHandlers:function(){a(document).unbind("keydown."+this.options.namespace,this._escapeHandler).unbind("click."+this.options.namespace,this._documentClickHandler)},_prev:function(){this._modalPrev.click()},_next:function(){this._modalNext.click()},_keyHandler:function(a){var b=a.data.gallery;switch(a.which){case 37:case 38:return b._prev(),!1;case 39:case 40:return b._next(),!1}},_wheelHandler:function(a){var b=a.data.gallery,a=a.originalEvent;b._wheelCounter=b._wheelCounter||0,b._wheelCounter+=a.wheelDelta||a.detail||0;if(a.wheelDelta&&120<=b._wheelCounter||!a.wheelDelta&&0>b._wheelCounter)b._prev(),b._wheelCounter=0;else if(a.wheelDelta&&-120>=b._wheelCounter||!a.wheelDelta&&0<b._wheelCounter)b._next(),b._wheelCounter=0;return!1},_showHandler:function(b){var b=b.data.gallery,d=b.options,e={gallery:b};a(document).bind("keydown."+d.namespace,e,b._keyHandler).bind("mousewheel."+d.namespace+", DOMMouseScroll."+d.namespace,e,b._wheelHandler)},_hideHandler:function(b){var b=b.data.gallery,d=b.options;a(document).unbind("keydown."+d.namespace,b._keyHandler).unbind("mousewheel."+d.namespace+", DOMMouseScroll."+d.namespace,b._wheelHandler),b._abortHandler(),window.clearTimeout(b._slideShow)},_initEventHandlers:function(){var b=this,d={gallery:this};a(this.element).delegate(this.options.selector,"click."+this.options.namespace,d,this._load),this._modalPrev.bind("click."+this.options.namespace,d,this._load),this._modalNext.bind("click."+this.options.namespace,d,this._load),this._modalBody.bind("click."+this.options.namespace,d,function(a){a.altKey?b._prev():b._next()}),this._modal.bind("show."+this.options.namespace,d,this._showHandler).bind("hide."+this.options.namespace,d,this._hideHandler)},_destroyEventHandlers:function(){this._modalPrev.unbind("click."+this.options.namespace),this._modalNext.unbind("click."+this.options.namespace),this._modalBody.unbind("click."+this.options.namespace),this._modal.unbind("show."+this.options.namespace).unbind("hide."+this.options.namespace),a(this.element).undelegate(this.options.selector,"click."+this.options.namespace)},_initTransitionSupport:function(){var a=(document.body||document.documentElement).style,b="."+this.options.namespace;if(this._transition=void 0!==a.transition||void 0!==a.WebkitTransition||void 0!==a.MozTransition||void 0!==a.MsTransition||void 0!==a.OTransition)this._transitionEnd=["TransitionEnd","webkitTransitionEnd","transitionend","oTransitionEnd"].join(b+" ")+b},_create:function(){this.options.namespace=this.options.namespace||this.widgetName,this._modal=a(this.options.modalSelector).modal({backdrop:this.options.backdrop,keyboard:this.options.keyboard}),this._loader=a(this.options.loaderSelector),this._modalTitle=this._modal.find(".modal-header .title"),this._modalBody=this._modal.find(".modal-body"),this._modalDownload=this._modal.find(".modal-footer .download"),this._modalPrev=this._modal.find(".modal-footer .prev"),this._modalNext=this._modal.find(".modal-footer .next"),this._initTransitionSupport(),this._initEventHandlers()},destroy:function(){window.clearTimeout(this._slideShow),this._destroyEventHandlers(),a.Widget.prototype.destroy.call(this)}})})(jQuery)