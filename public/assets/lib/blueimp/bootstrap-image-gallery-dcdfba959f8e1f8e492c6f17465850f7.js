/*
 * Bootstrap Image Gallery 1.0.2
 * https://github.com/blueimp/Bootstrap-Image-Gallery
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
/*jslint nomen: true */
/*global window, document, jQuery */
(function(a){"use strict",a.widget("blueimp.imagegallery",{options:{namespace:undefined,selector:"a[rel=gallery]",modalSelector:"#gallery-modal",loaderSelector:"#gallery-loader",backdrop:!0,keyboard:!0,offsetWidth:100,offsetHeight:200,canvas:!1,slideshow:0},_load:function(b){var c=b.data.gallery,d=c.options,e=a(window).width(),f=a(window).height(),g=c._modal.hasClass("fullscreen"),h;b.preventDefault(),c._abortHandler(),window.clearTimeout(c._slideShow),c.defer=a.Deferred(),c._isModalLink=a(this).parent().hasClass("modal-footer"),c._isModalLink?(a(this).hasClass("next")?c._currentLink=a(c._currentLink).data("next"):c._currentLink=a(c._currentLink).data("prev"),c._modal.removeClass("in")):(c._initLinks(),c._currentLink=this,c._initAbortHandlers()),c._isModalLink&&c._transition&&c._modal.hasClass("fade")?c._modal.bind(c._transitionEnd+"."+d.namespace,function(a){a.target===c._modal[0]&&(c._modal.unbind(c._transitionEnd+"."+d.namespace),c._initModal(),c.defer.resolve())}):(c._modal.hide(),c._initModal(),c.defer.resolve()),g?h={minWidth:e,minHeight:f,maxWidth:e,maxHeight:f,canvas:d.canvas}:h={maxWidth:e-d.offsetWidth,maxHeight:f-d.offsetHeight,canvas:d.canvas},c._loadingImageTimeout=window.setTimeout(function(){c._loader.addClass("in")},100),c._loadingImage=window.loadImage(c._currentLink.href,function(a){c._loadHandler(a)},h),c._preload()},_loadHandler:function(a){var b=this;this._abortHandler(),this._isModalLink?this.defer.done(function(){b._modal.show(),b._modal.addClass("in"),b._initModalBody(a)}):(this._initModalBody(a),this._modal.modal("show")),this.options.slideshow&&(this._slideShow=window.setTimeout(function(){b._next()},this.options.slideshow))},_initLinks:function(){var b=a(this.element).find(this.options.selector);b.each(function(c,d){var e=b[c-1],f=b[c+1];if(!e||e.href===d.href){e=b[c-2];if(!e||e.href===d.href)e=b[b.length-1]}if(!f||f.href===d.href){f=b[c+2];if(!f||f.href===d.href)f=b[0]}a(d).data("prev",e),a(d).data("next",f)})},_initModal:function(){var b=a(this._currentLink).data("prev"),c=a(this._currentLink).data("next");this._modalTitle.text(this._currentLink.title),this._modalDownload.prop("href",this._currentLink.href),this._modalPrev.prop("href",b.href).prop("title",b.title),this._modalNext.prop("href",c.href).prop("title",c.title)},_initModalBody:function(a){this._modalBody.empty().append(a),this._modal.css("margin-top",-(this._modal.outerHeight()/2)).css("margin-left",-(this._modal.outerWidth()/2))},_preload:function(){a("<img>").prop("src",a(this._currentLink).data("next").href),a("<img>").prop("src",a(this._currentLink).data("prev").href)},_abortHandler:function(){window.clearTimeout(this._loadingImageTimeout),this._destroyAbortHandlers(),this._loadingImage&&(this._loadingImage.onload=this._loadingImage.onerror=null),this._loader.removeClass("in")},_escapeHandler:function(a){var b=a.data.gallery;a.keyCode===27&&b._abortHandler()},_documentClickHandler:function(b){var c=b.data.gallery;a(b.target).closest(c._currentLink).length||c._abortHandler()},_initAbortHandlers:function(){var b={gallery:this};a(document).bind("keydown."+this.options.namespace,b,this._escapeHandler).bind("click."+this.options.namespace,b,this._documentClickHandler)},_destroyAbortHandlers:function(){a(document).unbind("keydown."+this.options.namespace,this._escapeHandler).unbind("click."+this.options.namespace,this._documentClickHandler)},_prev:function(){this._modalPrev.click()},_next:function(){this._modalNext.click()},_keyHandler:function(a){var b=a.data.gallery;switch(a.which){case 37:case 38:return b._prev(),!1;case 39:case 40:return b._next(),!1}},_wheelHandler:function(a){var b=a.data.gallery;a=a.originalEvent,b._wheelCounter=b._wheelCounter||0,b._wheelCounter+=a.wheelDelta||a.detail||0;if(a.wheelDelta&&b._wheelCounter>=120||!a.wheelDelta&&b._wheelCounter<0)b._prev(),b._wheelCounter=0;else if(a.wheelDelta&&b._wheelCounter<=-120||!a.wheelDelta&&b._wheelCounter>0)b._next(),b._wheelCounter=0;return!1},_showHandler:function(b){var c=b.data.gallery,d=c.options,e={gallery:c};a(document).bind("keydown."+d.namespace,e,c._keyHandler).bind("mousewheel."+d.namespace+", DOMMouseScroll."+d.namespace,e,c._wheelHandler)},_hideHandler:function(b){var c=b.data.gallery,d=c.options;a(document).unbind("keydown."+d.namespace,c._keyHandler).unbind("mousewheel."+d.namespace+", DOMMouseScroll."+d.namespace,c._wheelHandler),c._abortHandler(),window.clearTimeout(c._slideShow)},_initEventHandlers:function(){var b=this,c={gallery:this};a(this.element).delegate(this.options.selector,"click."+this.options.namespace,c,this._load),this._modalPrev.bind("click."+this.options.namespace,c,this._load),this._modalNext.bind("click."+this.options.namespace,c,this._load),this._modalBody.bind("click."+this.options.namespace,c,function(a){a.altKey?b._prev():b._next()}),this._modal.bind("show."+this.options.namespace,c,this._showHandler).bind("hide."+this.options.namespace,c,this._hideHandler)},_destroyEventHandlers:function(){this._modalPrev.unbind("click."+this.options.namespace),this._modalNext.unbind("click."+this.options.namespace),this._modalBody.unbind("click."+this.options.namespace),this._modal.unbind("show."+this.options.namespace).unbind("hide."+this.options.namespace),a(this.element).undelegate(this.options.selector,"click."+this.options.namespace)},_initTransitionSupport:function(){var a=this,b=(document.body||document.documentElement).style,c="."+a.options.namespace;a._transition=b.transition!==undefined||b.WebkitTransition!==undefined||b.MozTransition!==undefined||b.MsTransition!==undefined||b.OTransition!==undefined,a._transition&&(a._transitionEnd=["TransitionEnd","webkitTransitionEnd","transitionend","oTransitionEnd"].join(c+" ")+c)},_create:function(){this.options.namespace=this.options.namespace||this.widgetName,this._modal=a(this.options.modalSelector).modal({backdrop:this.options.backdrop,keyboard:this.options.keyboard}),this._loader=a(this.options.loaderSelector),this._modalTitle=this._modal.find(".modal-header .title"),this._modalBody=this._modal.find(".modal-body"),this._modalDownload=this._modal.find(".modal-footer .download"),this._modalPrev=this._modal.find(".modal-footer .prev"),this._modalNext=this._modal.find(".modal-footer .next"),this._initTransitionSupport(),this._initEventHandlers()},destroy:function(){window.clearTimeout(this._slideShow),this._destroyEventHandlers(),a.Widget.prototype.destroy.call(this)}})})(jQuery);