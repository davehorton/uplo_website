- content_for :head do
  = stylesheet_link_tag("scss/cart_new.css")
  = stylesheet_link_tag("tip-yellow/tip-yellow.css")


- content_for :top_content do
  .text.black.bold.font16.left Checkout - Step 2 of 2
  .line-separator.left
- if @order.expiration
  - @order.expiration = Date.strptime(@order.expiration, "%m-%Y") 
- else
  - @order.expiration = Date.today
.wrapper
  = simple_form_for(@order, :url => "/payments/checkout?type=an", :html => {:class => "card_form left", :id => 'order-shippings'}) do |f|
    #billing-address.order_summary.left
      .header
        %span.text.black.bold.font16.left Billing Address
        .italic.text.heavy-gray.font11.left
          %span{:style=>'color:red;'} &nbsp;&nbsp;&nbsp;*
          Required Fields
      .line-separator.left
      = f.fields_for :billing_address do |billing_f|
        .inputs.left
          .info
            = billing_f.label :first_name, "First Name <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(billing_f.object, :first_name)
            - css = message ? "error" : nil
            = billing_f.input_field :first_name, :autofocus => true, :required => true, :class => css, :title => message
          .info
            = billing_f.label :last_name, "Last Name <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(billing_f.object, :last_name)
            - css = message ? "error" : nil
            = billing_f.input_field :last_name, :required => true, :class => css, :title => message
          .info
            = billing_f.label :street_address, "Street Address <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(billing_f.object, :street_address)
            - css = message ? "error" : nil
            = billing_f.input_field :street_address, :required => true, :class => css, :title => message
          .info
            = label_tag :optional_address, ""
            = billing_f.input_field :optional_address
          .info
            = billing_f.label :city, "City <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(billing_f.object, :city)
            - css = message ? "error" : nil
            = billing_f.input_field :city, :required => true, :class => css, :title => message
          .info
            = billing_f.label :state, "State <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(billing_f.object, :state)
            - css = message ? "error" : nil
            = billing_f.select :state, state_options(@order.billing_address.state), {:required => true,  :prompt => 'Select One', :class => css, :title => message}
          .info
            = billing_f.label :zip, "Postal/Zip Code <span style='color:red;'>*</span>".html_safe            
            - message = first_error_message_for(billing_f.object, :zip)
            - css = message ? "error" : nil
            = billing_f.input_field :zip, :required => true, :class => css, :title => message
          
          .info
            / = hidden_field_tag 'billing[ship_to_billing]', 0
            %input{ :type => 'checkbox', :name => 'order[ship_to_billing]', :value => '1', :id => 'billing_ship_to_billing', :class => 'left', :checked =>  'checked' }
            = label_tag :billing_ship_to_billing, 'Ship Items to the Above Billing Address', :style => 'line-height:15px; width:auto;', :class => 'left'

    .left
      #shipping-address.order_summary.left
        .header
          %span.text.black.bold.font16.left Shipping Address
          .italic.text.heavy-gray.font11.left.hide
            %span{:style=>'color:red;'} &nbsp;&nbsp;&nbsp;*
            Required Fields
        .line-separator.left
        .edit.left
          %span Item(s) will be shipped to your billing address
          %a.right{:href => '#'} Edit
        .inputs.clear.hide
          = f.fields_for :shipping_address do |shipping_f|
            .info
              = shipping_f.label :first_name, "First Name <span style='color:red;'>*</span>".html_safe
              - message = first_error_message_for(shipping_f.object, :first_name)
              - css = message ? "error" : nil
              = shipping_f.input_field :first_name, :autofocus => true, :required => true, :class => css, :title => message
            .info
              = shipping_f.label :last_name, "Last Name <span style='color:red;'>*</span>".html_safe
              - message = first_error_message_for(shipping_f.object, :last_name)
              - css = message ? "error" : nil
              = shipping_f.input_field :last_name, :required => true, :class => css, :title => message
            .info
              = shipping_f.label :street_address, "Street Address <span style='color:red;'>*</span>".html_safe
              - message = first_error_message_for(shipping_f.object, :street_address)
              - css = message ? "error" : nil
              = shipping_f.input_field :street_address, :required => true, :class => css, :title => message
            .info
              = label_tag :optional_address, ""
              = shipping_f.input_field :optional_address
            .info
              = shipping_f.label :city, "City <span style='color:red;'>*</span>".html_safe
              - message = first_error_message_for(shipping_f.object, :city)
              - css = message ? "error" : nil
              = shipping_f.input_field :city, :required => true, :class => css, :title => message
            .info
              = shipping_f.label :state, "State <span style='color:red;'>*</span>".html_safe
              - message = first_error_message_for(shipping_f.object, :state)
              - css = message ? "error" : nil
              = shipping_f.select :state, state_options(@order.shipping_address.state), {:required => true,  :prompt => 'Select One', :class => css, :title => message}
            .info
              = shipping_f.label :zip, "Postal/Zip Code <span style='color:red;'>*</span>".html_safe
              - message = first_error_message_for(shipping_f.object, :zip)
              - css = message ? "error" : nil
              = shipping_f.input_field :zip, :required => true, :class => css, :title => message
          

      .order_summary.clear{:style => "padding-top:35px;"}
        .header
          .text.black.bold.font16.left Payment Information
          .italic.text.heavy-gray.font11.left
            %span{:style=>'color:red;'} &nbsp;&nbsp;&nbsp;*
            Required Fields
        .line-separator.left
        .inputs.left
          .info
            = f.label :name_on_card, "Name on Card <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(f.object, :name_on_card)
            - css = message ? "error" : nil
            = f.input_field :name_on_card, :autofocus => true, :required => true, :label => false, :class => css, :title => message
          .info
            = f.label :card_type, "Card Type <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(f.object, :card_type)
            - css = message ? "error" : nil
            = f.select :card_type, options_for_select(User.card_types, @order.card_type), {:prompt => 'Select One', :class => css, :title => message}
          .info
            = f.label :card_number, "Card Number <span style='color:red;'>*</span>".html_safe
            - message = first_error_message_for(f.object, :card_number)
            - css = message ? "error" : nil
            = f.input_field :card_number, :autofocus => true, :required => true, :label => false, :class => css, :title => message
          .info.expiration-date
            - today = Date.today
            = f.label :expiration, "Expiration Date <span style='color:red;'>*</span>".html_safe
            = f.date_select :expiration, :discard_day => true, :start_year => Date.today.year, :end_year => (Date.today.year+10), :add_month_numbers => false, :order => [:month, :year], :required => true, :label => false, :default => { :day => '1', :mon => '12' }, :prompt => { :month => 'Month', :year => 'Year' }

          .info
            = f.label :cvv, "CVV <span style='color:red;'>*</span> <span id='cvv-explanation'>What's This?</span>".html_safe
            - message = first_error_message_for(f.object, :cvv)
            - css = message ? "error" : nil
            = f.input_field :cvv, :required => true, :label => false, :maxlength => 4, :class => css, :title => message
          = hidden_field_tag :order_id, @order.id

    #order-summary.order_summary.no-padding-right.left{:style => "height:auto;min-height: 100px;"}
      .header.text.black.bold.font16 Order Summary
      .solid-block.left
        - subtotal = 0
        - tax_total = 0
        - (0...@order.line_items.length).each do |idx|
          - line_item = @order.line_items[idx]
          - subtotal += line_item.price * line_item.quantity
          - tax_total += line_item.tax * line_item.quantity
          .block.text.black.line22.left{:style => "#{'padding-top:0;' if idx==0}"}
            .name.line.text.bold.line12.left= line_item.image.name.truncate(36)
            .line.no-background.left
              .text.font10.left QTY
              .text.bold.font13.right= line_item.quantity
            .line.left
              .text.font10.left PRICE
              .text.bold.font13.right= number_to_currency(line_item.price * line_item.quantity)
            .line.no-background.left
              .text.font10.left TAX
              .text.bold.font13.right= number_to_currency(line_item.tax * line_item.quantity)
        .summary.text.black.font11.line18.right
          .text.bold.right
            .left Subtotal:
            .right= number_to_currency subtotal
          .text.right.clear
            .left Tax:
            .right= number_to_currency tax_total
          .text.clear
            .left Shipping & Handling:
            .right= number_to_currency SHIPPING_FEE

        .line-separator.left
        .summary.right
          .grand-total.text.black.bold.font14.line18.right.clear
            .left Grand Total:
            .right= number_to_currency(tax_total + subtotal + SHIPPING_FEE)
        .line-separator.left
        .submit.right

= render :partial => 'orders/cvv_form', :layout => 'layouts/bubble', :locals => { :id => 'cvv-form' }

- content_for :js do
  = javascript_include_tag 'app/order.js', 'app/form_validation.js'
  = javascript_tag do
    :erb
      $(".zip_input").keypress(function (event) {
        var reg = /^\d{0,5}$/;
        if (!event.charCode) return true;
        var part1 = this.value.substring(0,this.selectionStart);
        var part2 = this.value.substring(this.selectionEnd,this.value.length);
        if (!reg.test(part1 + String.fromCharCode(event.charCode) + part2)){
          return false;
        }
      });
      $('#shipping-address .edit a').bind('click', function(){
        $('#shipping-address .inputs').removeClass('hide').addClass('show');
        $('#shipping-address .edit').removeClass('show').addClass('hide');
        $('#billing_ship_to_billing').attr('checked', false);
        $('#shipping-address .header .italic').removeClass('hide').addClass('show');
      });
      $('#billing_ship_to_billing').bind('click', function(){
        console.log($(this).attr('checked'));
        if($(this).attr('checked') == 'checked'){
          $('#shipping-address .inputs').removeClass('show').addClass('hide');
          $('#shipping-address .header .italic').removeClass('show').addClass('hide');
          $('#shipping-address .edit').removeClass('hide').addClass('show');
        } else {
          $('#shipping-address .inputs').removeClass('hide').addClass('show');
          $('#shipping-address .header .italic').removeClass('hide').addClass('show');
          $('#shipping-address .edit').removeClass('show').addClass('hide');
        }
      });
      $('.submit').bind('click', function(){
        if($('#shipping-address .edit.hide').length==0) {
          $('#shipping-address .inputs').text("");
        }

        // Google Analytics
        _gaq.push(['_trackEvent', 'UPLO Web / Check Out', 'Place Order', 'checkout', -1]);

        $('#order-shippings').submit();
      });

      <% if (@remove_shipping_info != nil && @remove_shipping_info == false) %>
        $('#shipping-address .edit a').click();
      <% end %>



      // Form inline error showing
      form_validation.setup($('form.simple_form .error'));
